<h4 style="color: #155724;">Combustible Ahorrado</h4>
                                <div style="font-size: 2em; color: #155724; font-weight: bold;">127 L</div>
                                <small>Esta semana vs m√©todo manual</small>
                            </div>
                            <div style="background: #cce5ff; padding: 20px; border-radius: 10px; text-align: center;">
                                <h4 style="color: #004085;">Tiempo Ahorrado</h4>
                                <div style="font-size: 2em; color: #004085; font-weight: bold;">8.5 hrs</div>
                                <small>Por d√≠a en planificaci√≥n</small>
                            </div>
                            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; text-align: center;">
                                <h4 style="color: #856404;">Costo Evitado</h4>
                                <div style="font-size: 2em; color: #856404; font-weight: bold;">S/ 2,400</div>
                                <small>En conflictos y retrasos</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido de Fundamentos Matem√°ticos -->
            <div id="math" class="tab-content hidden">
                <div class="section">
                    <h2>Fundamentos Matem√°ticos Aplicados</h2>
                    
                    <h3>1. Teor√≠a de Conjuntos</h3>
                    <div class="math-formula">
                        <strong>Conjuntos del Sistema:</strong><br>
                        F = {F1, F2, F3} (Furgones)<br>
                        P = {P1, P2, P3, P4} (Puntos de Recolecci√≥n)<br>
                        T = {M, T} (Turnos: Ma√±ana, Tarde)<br><br>
                        <strong>Producto Cartesiano:</strong><br>
                        Asignaciones_Posibles = F √ó P √ó T<br>
                        |Asignaciones_Posibles| = 3 √ó 4 √ó 2 = 24
                    </div>

                    <h3>2. L√≥gica Proposicional</h3>
                    <div class="math-formula">
                        <strong>Reglas de Validaci√≥n:</strong><br>
                        ‚àÄ f ‚àà F, ‚àÄ t ‚àà T: ‚àë(asignaciones_furgon_f_turno_t) ‚â§ 1<br>
                        ‚àÄ p ‚àà P, ‚àÄ t ‚àà T: ‚àë(asignaciones_punto_p_turno_t) ‚â§ 1<br><br>
                        <strong>Funci√≥n de Conflicto:</strong><br>
                        Conflicto(f,p,t) = (count_furgon(f,t) > 1) ‚à® (count_punto(p,t) > 1)
                    </div>

                    <h3>3. √Ålgebra de Boole</h3>
                    <div class="math-formula">
                        <strong>Variables Booleanas:</strong><br>
                        A_ijt = 1 si furg√≥n_i asignado a punto_j en turno_t<br>
                        A_ijt = 0 en caso contrario<br><br>
                        <strong>Restricciones:</strong><br>
                        ‚àë_j A_ijt ‚â§ 1  (Un furg√≥n, m√°ximo un punto por turno)<br>
                        ‚àë_i A_ijt ‚â§ 1  (Un punto, m√°ximo un furg√≥n por turno)
                    </div>

                    <h3>4. Teor√≠a de Grafos</h3>
                    <div class="math-formula">
                        <strong>Grafo de Conflictos G = (V, E):</strong><br>
                        V = {todas las asignaciones posibles}<br>
                        E = {(v1, v2) | v1 y v2 generan conflicto}<br><br>
                        <strong>Conjunto Independiente:</strong><br>
                        I ‚äÜ V tal que ‚àÄ u,v ‚àà I: (u,v) ‚àâ E<br>
                        Objetivo: Encontrar conjunto independiente m√°ximo
                    </div>

                    <div class="section">
                        <h3>Simulador de Validaci√≥n Matem√°tica</h3>
                        <div class="form-section">
                            <h4>Probar Asignaci√≥n:</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Furg√≥n:</label>
                                    <select id="testVehicle">
                                        <option value="F1">F1</option>
                                        <option value="F2">F2</option>
                                        <option value="F3">F3</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Punto:</label>
                                    <select id="testPoint">
                                        <option value="P1">P1</option>
                                        <option value="P2">P2</option>
                                        <option value="P3">P3</option>
                                        <option value="P4">P4</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Turno:</label>
                                    <select id="testShift">
                                        <option value="M">Ma√±ana</option>
                                        <option value="T">Tarde</option>
                                    </select>
                                </div>
                            </div>
                            <button class="btn" onclick="validateMathematically()">üßÆ Validar Matem√°ticamente</button>
                            <div id="mathResult" style="margin-top: 15px; padding: 15px; border-radius: 8px; display: none;">
                                <h4>Resultado del An√°lisis Matem√°tico:</h4>
                                <div id="mathDetails"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Airtable
        let airtableConfig = {
            token: '',
            baseId: '',
            tables: {
                assignments: 'Asignaciones',
                vehicles: 'Furgones', 
                points: 'Puntos_Recoleccion'
            },
            connected: false,
            autoSync: false,
            syncInterval: 30000
        };

        // Datos del sistema
        let assignments = [
            {id: 1, date: '2025-07-14', shift: 'M', vehicle: 'F1', point: 'P1', status: 'Programada', airtableId: null, syncStatus: 'pending'},
            {id: 2, date: '2025-07-14', shift: 'M', vehicle: 'F2', point: 'P2', status: 'Programada', airtableId: null, syncStatus: 'pending'},
            {id: 3, date: '2025-07-14', shift: 'T', vehicle: 'F3', point: 'P3', status: 'Programada', airtableId: null, syncStatus: 'pending'}
        ];

        let vehicles = [
            {id: 'F1', code: 'F1', capacity: 8, status: 'Activo', driver: 'Juan P√©rez', location: 'Base Central', airtableId: null},
            {id: 'F2', code: 'F2', capacity: 10, status: 'Activo', driver: 'Mar√≠a Garc√≠a', location: 'En ruta', airtableId: null},
            {id: 'F3', code: 'F3', capacity: 12, status: 'Mantenimiento', driver: '', location: 'Taller', airtableId: null}
        ];

        let points = [
            {id: 'P1', code: 'P1', address: 'Av. Principal 123 - Centro Comercial Plaza', type: 'Mixto', volume: 15, frequency: 'Diaria', coordinates: '-12.0464, -77.0428', airtableId: null},
            {id: 'P2', code: 'P2', address: 'Jr. Comercio 456 - Mercado Central', type: 'Org√°nico', volume: 25, frequency: 'Diaria', coordinates: '-12.0546, -77.0365', airtableId: null},
            {id: 'P3', code: 'P3', address: 'Calle Las Flores 789 - Zona Residencial Norte', type: 'Inorg√°nico', volume: 8, frequency: 'Inter-diaria', coordinates: '-12.0623, -77.0512', airtableId: null},
            {id: 'P4', code: 'P4', address: 'Av. Industrial 321 - Parque Industrial', type: 'Industrial', volume: 30, frequency: 'Diaria', coordinates: '-12.0234, -77.0891', airtableId: null}
        ];

        let nextId = 4;
        let syncTimer = null;

        // Funciones de navegaci√≥n
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.remove('hidden');
            event.target.classList.add('active');
        }

        // Funci√≥n para validar conflictos usando matem√°ticas discretas
        function hasConflict(newAssignment) {
            return assignments.some(existing => {
                const vehicleConflict = existing.vehicle === newAssignment.vehicle && 
                                      existing.shift === newAssignment.shift && 
                                      existing.date === newAssignment.date;
                
                const pointConflict = existing.point === newAssignment.point && 
                                     existing.shift === newAssignment.shift && 
                                     existing.date === newAssignment.date;
                
                return vehicleConflict || pointConflict;
            });
        }

        // Funciones de Airtable API Real
        async function connectToAirtable() {
            const token = document.getElementById('airtableToken').value;
            const baseId = document.getElementById('airtableBaseId').value;
            
            if (!token || !baseId) {
                showNotification('‚ùå Por favor ingrese Token y Base ID', 'error');
                return;
            }

            showLoading(true);
            
            try {
                airtableConfig.token = token;
                airtableConfig.baseId = baseId;
                airtableConfig.tables.assignments = document.getElementById('assignmentsTableId').value;
                airtableConfig.tables.vehicles = document.getElementById('vehiclesTableId').value;
                airtableConfig.tables.points = document.getElementById('pointsTableId').value;
                
                const testUrl = `https://api.airtable.com/v0/${baseId}/${airtableConfig.tables.vehicles}?maxRecords=1`;
                const response = await fetch(testUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    airtableConfig.connected = true;
                    updateConnectionStatus(true);
                    showNotification('‚úÖ Conectado exitosamente a Airtable', 'success');
                    
                    await loadInitialData();
                    
                    if (document.getElementById('autoSync').checked) {
                        startAutoSync();
                    }
                } else {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                showNotification('‚ùå Error al conectar: ' + error.message, 'error');
                airtableConfig.connected = false;
                updateConnectionStatus(false);
                console.error('Error de conexi√≥n:', error);
            }
            
            showLoading(false);
        }

        async function testConnection() {
            if (!airtableConfig.connected) {
                showNotification('‚ùå Primero debe conectarse a Airtable', 'error');
                return;
            }

            showLoading(true);
            
            try {
                const startTime = performance.now();
                
                const testUrl = `https://api.airtable.com/v0/${airtableConfig.baseId}/${airtableConfig.tables.vehicles}?maxRecords=1`;
                const response = await fetch(testUrl, {
                    headers: {
                        'Authorization': `Bearer ${airtableConfig.token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const endTime = performance.now();
                const responseTime = Math.round(endTime - startTime);
                
                if (response.ok) {
                    showNotification('‚úÖ Conexi√≥n exitosa! API respondiendo correctamente', 'success');
                    document.getElementById('avgResponseTime').textContent = responseTime + 'ms';
                } else {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                showNotification('‚ùå Error en la conexi√≥n: ' + error.message, 'error');
            }
            
            showLoading(false);
        }

        function disconnectAirtable() {
            airtableConfig.connected = false;
            airtableConfig.token = '';
            airtableConfig.baseId = '';
            
            updateConnectionStatus(false);
            stopAutoSync();
            
            document.getElementById('airtableToken').value = '';
            document.getElementById('airtableBaseId').value = '';
            
            showNotification('‚ö†Ô∏è Desconectado de Airtable', 'warning');
        }

        async function loadInitialData() {
            try {
                await loadVehiclesFromAirtable();
                await loadPointsFromAirtable();
                await loadAssignmentsFromAirtable();
                
                showNotification('üì• Datos iniciales cargados desde Airtable', 'success');
            } catch (error) {
                showNotification('‚ö†Ô∏è Error cargando datos iniciales: ' + error.message, 'warning');
            }
        }

        async function loadVehiclesFromAirtable() {
            if (!airtableConfig.connected) return;
            
            try {
                const url = `https://api.airtable.com/v0/${airtableConfig.baseId}/${airtableConfig.tables.vehicles}`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${airtableConfig.token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.records.length > 0) {
                        vehicles = data.records.map(record => ({
                            id: record.fields.Codigo,
                            code: record.fields.Codigo,
                            capacity: record.fields.Capacidad_Toneladas,
                            status: record.fields.Estado || 'Activo',
                            driver: record.fields.Conductor || '',
                            location: record.fields.Ubicacion_Actual || 'Base Central',
                            airtableId: record.id
                        }));
                    }
                    
                    updateVehiclesTable();
                    updateSyncStatusTable('vehicles', vehicles.length);
                }
            } catch (error) {
                console.error('Error cargando veh√≠culos:', error);
            }
        }

        async function loadPointsFromAirtable() {
            if (!airtableConfig.connected) return;
            
            try {
                const url = `https://api.airtable.com/v0/${airtableConfig.baseId}/${airtableConfig.tables.points}`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${airtableConfig.token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.records.length > 0) {
                        points = data.records.map(record => ({
                            id: record.fields.Codigo,
                            code: record.fields.Codigo,
                            address: record.fields.Direccion || '',
                            type: record.fields.Tipo_Residuo || 'Mixto',
                            volume: record.fields.Volumen_Estimado || 0,
                            frequency: record.fields.Frecuencia || 'Diaria',
                            coordinates: record.fields.Coordenadas_GPS || '',
                            airtableId: record.id
                        }));
                    }
                    
                    updatePointsTable();
                    updateSyncStatusTable('points', points.length);
                    updatePointsSelect();
                }
            } catch (error) {
                console.error('Error cargando puntos:', error);
            }
        }

        async function loadAssignmentsFromAirtable() {
            if (!airtableConfig.connected) return;
            
            try {
                const url = `https://api.airtable.com/v0/${airtableConfig.baseId}/${airtableConfig.tables.assignments}`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${airtableConfig.token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.records.length > 0) {
                        assignments = data.records.map(record => {
                            // Manejar los campos vinculados que vienen como arrays
                            let vehicleCode = '';
                            let pointCode = '';
                            
                            if (record.fields.Furgon && Array.isArray(record.fields.Furgon)) {
                                // Buscar el c√≥digo del veh√≠culo basado en el ID de Airtable
                                const vehicleRecord = vehicles.find(v => v.airtableId === record.fields.Furgon[0]);
                                vehicleCode = vehicleRecord ? vehicleRecord.code : 'F1';
                            }
                            
                            if (record.fields.Punto && Array.isArray(record.fields.Punto)) {
                                // Buscar el c√≥digo del punto basado en el ID de Airtable
                                const pointRecord = points.find(p => p.airtableId === record.fields.Punto[0]);
                                pointCode = pointRecord ? pointRecord.code : 'P1';
                            }
                            
                            return {
                                id: record.fields.ID_Asignacion || record.id,
                                date: record.fields.Fecha,
                                shift: record.fields.Turno === 'Ma√±ana' ? 'M' : 'T',
                                vehicle: vehicleCode,
                                point: pointCode,
                                status: record.fields.Estado || 'Programada',
                                airtableId: record.id,
                                syncStatus: 'synced'
                            };
                        });
                    }
                    
                    updateAssignmentsTable();
                    updateSyncStatusTable('assignments', assignments.length);
                }
            } catch (error) {
                console.error('Error cargando asignaciones:', error);
            }
        }

        function updatePointsSelect() {
            const pointSelect = document.getElementById('assignPoint');
            pointSelect.innerHTML = '<option value="">Seleccionar punto...</option>';
            
            points.forEach(point => {
                const option = document.createElement('option');
                option.value = point.code;
                option.textContent = `${point.code} - ${point.address.split(' - ')[1] || point.address.substring(0, 30)}`;
                pointSelect.appendChild(option);
            });
        }

        async function createAssignmentInAirtable(assignment) {
            if (!airtableConfig.connected) return null;
            
            try {
                const vehicleRecord = vehicles.find(v => v.code === assignment.vehicle);
                const pointRecord = points.find(p => p.code === assignment.point);
                
                if (!vehicleRecord?.airtableId || !pointRecord?.airtableId) {
                    throw new Error('Veh√≠culo o punto no encontrado en Airtable');
                }
                
                const url = `https://api.airtable.com/v0/${airtableConfig.baseId}/${airtableConfig.tables.assignments}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${airtableConfig.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        records: [{
                            fields: {
                                Fecha: assignment.date,
                                Turno: assignment.shift === 'M' ? 'Ma√±ana' : 'Tarde',
                                Furgon: [vehicleRecord.airtableId],
                                Punto: [pointRecord.airtableId],
                                Estado: assignment.status || 'Programada'
                            }
                        }]
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.records[0].id;
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Error creando asignaci√≥n');
                }
                
            } catch (error) {
                console.error('Error creando asignaci√≥n en Airtable:', error);
                throw error;
            }
        }

        async function addAssignment() {
            const date = document.getElementById('assignDate').value;
            const shift = document.getElementById('assignShift').value;
            const vehicle = document.getElementById('assignVehicle').value;
            const point = document.getElementById('assignPoint').value;

            if (!date || !shift || !vehicle || !point) {
                showNotification('‚ùå Por favor complete todos los campos', 'error');
                return;
            }

            const newAssignment = {
                id: nextId++,
                date: date,
                shift: shift,
                vehicle: vehicle,
                point: point,
                status: 'Programada',
                airtableId: null,
                syncStatus: 'pending'
            };

            if (hasConflict(newAssignment)) {
                document.getElementById('conflictAlert').classList.remove('hidden');
                document.getElementById('validationAlert').classList.add('hidden');
                setTimeout(() => {
                    document.getElementById('conflictAlert').classList.add('hidden');
                }, 5000);
                return;
            }

            assignments.push(newAssignment);
            
            // Auto-sincronizar con Airtable si est√° conectado
            if (airtableConfig.connected) {
                try {
                    document.getElementById('syncAlert').classList.remove('hidden');
                    const airtableId = await createAssignmentInAirtable(newAssignment);
                    
                    if (airtableId) {
                        const assignment = assignments.find(a => a.id === newAssignment.id);
                        if (assignment) {
                            assignment.airtableId = airtableId;
                            assignment.syncStatus = 'synced';
                        }
                        showNotification('‚úÖ Asignaci√≥n creada y sincronizada con Airtable', 'success');
                    }
                    
                    document.getElementById('syncAlert').classList.add('hidden');
                } catch (error) {
                    document.getElementById('syncAlert').classList.add('hidden');
                    showNotification('‚ö†Ô∏è Asignaci√≥n creada localmente. Error en sync: ' + error.message, 'warning');
                }
            }
            
            document.getElementById('validationAlert').classList.remove('hidden');
            document.getElementById('conflictAlert').classList.add('hidden');
            
            setTimeout(() => {
                document.getElementById('validationAlert').classList.add('hidden');
            }, 3000);

            updateAssignmentsTable();
            updateMetrics();
            
            // Limpiar formulario
            document.getElementById('assignShift').value = '';
            document.getElementById('assignVehicle').value = '';
            document.getElementById('assignPoint').value = '';
        }

        function updateAssignmentsTable() {
            const tableBody = document.getElementById('assignmentsTable');
            tableBody.innerHTML = '';

            assignments.forEach(assignment => {
                const row = document.createElement('tr');
                const shiftName = assignment.shift === 'M' ? 'Ma√±ana' : 'Tarde';
                const syncStatus = assignment.airtableId ? 
                    '<span class="status synced">‚úÖ Sincronizado</span>' : 
                    '<span class="status pending">‚è≥ Pendiente</span>';
                
                row.innerHTML = `
                    <td>${assignment.id.toString().padStart(3, '0')}</td>
                    <td>${assignment.date}</td>
                    <td>${shiftName}</td>
                    <td>${assignment.vehicle}</td>
                    <td>${assignment.point}</td>
                    <td><span class="status valid">${assignment.status}</span></td>
                    <td>${assignment.airtableId || '-'}</td>
                    <td>${syncStatus}</td>
                    <td>
                        <button class="btn" onclick="removeAssignment(${assignment.id})" title="Eliminar">üóëÔ∏è</button>
                        ${!assignment.airtableId ? '<button class="btn btn-airtable" onclick="syncSingleAssignment(' + assignment.id + ')" title="Sincronizar">‚òÅÔ∏è</button>' : ''}
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        function updateVehiclesTable() {
            const tableBody = document.getElementById('vehiclesTable');
            tableBody.innerHTML = '';

            vehicles.forEach(vehicle => {
                const row = document.createElement('tr');
                const assignmentsCount = assignments.filter(a => a.vehicle === vehicle.code).length;
                const syncStatus = vehicle.airtableId ? 
                    '<span class="status synced">‚úÖ Sincronizado</span>' : 
                    '<span class="status pending">‚è≥ Pendiente</span>';
                
                row.innerHTML = `
                    <td>${vehicle.code}</td>
                    <td>${vehicle.capacity}</td>
                    <td><span class="status ${vehicle.status === 'Activo' ? 'valid' : 'pending'}">${vehicle.status}</span></td>
                    <td>${vehicle.driver}</td>
                    <td>${vehicle.location}</td>
                    <td>${assignmentsCount}</td>
                    <td>${vehicle.airtableId || '-'}</td>
                    <td>${syncStatus}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        function updatePointsTable() {
            const tableBody = document.getElementById('pointsTable');
            tableBody.innerHTML = '';

            points.forEach(point => {
                const row = document.createElement('tr');
                const syncStatus = point.airtableId ? 
                    '<span class="status synced">‚úÖ Sincronizado</span>' : 
                    '<span class="status pending">‚è≥ Pendiente</span>';
                
                row.innerHTML = `
                    <td>${point.code}</td>
                    <td>${point.address}</td>
                    <td>${point.type}</td>
                    <td>${point.volume}</td>
                    <td>${point.frequency}</td>
                    <td>${point.coordinates}</td>
                    <td>${point.airtableId || '-'}</td>
                    <td>${syncStatus}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        async function removeAssignment(id) {
            const assignment = assignments.find(a => a.id === id);
            
            if (assignment && assignment.airtableId && airtableConfig.connected) {
                try {
                    const url = `https://api.airtable.com/v0/${airtableConfig.baseId}/${airtableConfig.tables.assignments}/${assignment.airtableId}`;
                    const response = await fetch(url, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${airtableConfig.token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        showNotification('‚úÖ Asignaci√≥n eliminada de Airtable', 'success');
                    }
                } catch (error) {
                    showNotification('‚ö†Ô∏è Error eliminando de Airtable: ' + error.message, 'warning');
                }
            }
            
            assignments = assignments.filter(assignment => assignment.id !== id);
            updateAssignmentsTable();
            updateMetrics();
            showNotification('üóëÔ∏è Asignaci√≥n eliminada', 'warning');
        }

        function clearAssignments() {
            if (confirm('¬øEst√° seguro de que desea eliminar todas las asignaciones?')) {
                assignments = [];
                updateAssignmentsTable();
                updateMetrics();
                showNotification('üóëÔ∏è Todas las asignaciones eliminadas', 'warning');
            }
        }

        function validateAllAssignments() {
            let conflicts = 0;
            const conflictDetails = [];

            for (let i = 0; i < assignments.length; i++) {
                for (let j = i + 1; j < assignments.length; j++) {
                    const a1 = assignments[i];
                    const a2 = assignments[j];

                    if (a1.date === a2.date && a1.shift === a2.shift) {
                        if (a1.vehicle === a2.vehicle) {
                            conflicts++;
                            conflictDetails.push(`‚ö†Ô∏è CONFLICTO FURG√ìN: ${a1.vehicle} asignado a ${a1.point} y ${a2.point} en el mismo turno`);
                        }
                        if (a1.point === a2.point) {
                            conflicts++;
                            conflictDetails.push(`‚ö†Ô∏è CONFLICTO PUNTO: ${a1.point} asignado a ${a1.vehicle} y ${a2.vehicle} en el mismo turno`);
                        }
                    }
                }
            }

            if (conflicts === 0) {
                showNotification('‚úÖ V√ÅLIDA - Todas las asignaciones cumplen las reglas matem√°ticas', 'success');
            } else {
                showNotification(`‚ùå INV√ÅLIDA - Se detectaron ${conflicts} conflictos`, 'error');
            }
        }

        function updateMetrics() {
            document.getElementById('totalAssignments').textContent = assignments.length;
            document.getElementById('localAssignments').textContent = assignments.length;
            
            const syncedCount = assignments.filter(a => a.airtableId).length;
            document.getElementById('syncedCount').textContent = `${syncedCount} sincronizadas`;
            
            const efficiency = Math.max(60, 100 - (assignments.length * 2));
            document.getElementById('fleetEfficiency').textContent = efficiency + '%';
        }

        // Funciones de sincronizaci√≥n
        async function syncAllData() {
            if (!airtableConfig.connected) {
                showNotification('‚ùå No est√° conectado a Airtable', 'error');
                return;
            }

            showNotification('üîÑ Iniciando sincronizaci√≥n completa...', 'info');
            
            try {
                await loadInitialData();
                showNotification('‚úÖ Sincronizaci√≥n completa exitosa', 'success');
                updateSyncMetrics();
                
            } catch (error) {
                showNotification('‚ùå Error en sincronizaci√≥n: ' + error.message, 'error');
            }
        }

        async function syncAssignments() {
            if (!airtableConfig.connected) return;
            
            showLoading(true);
            
            try {
                await loadAssignmentsFromAirtable();
                showNotification('‚úÖ Asignaciones sincronizadas desde Airtable', 'success');
                
            } catch (error) {
                showNotification('‚ùå Error sincronizando asignaciones', 'error');
            }
            
            showLoading(false);
        }

        async function syncVehicles() {
            if (!airtableConfig.connected) return;
            
            showLoading(true);
            
            try {
                await loadVehiclesFromAirtable();
                showNotification('‚úÖ Furgones sincronizados desde Airtable', 'success');
                
            } catch (error) {
                showNotification('‚ùå Error sincronizando furgones', 'error');
            }
            
            showLoading(false);
        }

        async function syncPoints() {
            if (!airtableConfig.connected) return;
            
            showLoading(true);
            
            try {
                await loadPointsFromAirtable();
                showNotification('‚úÖ Puntos sincronizados desde Airtable', 'success');
                
            } catch (error) {
                showNotification('‚ùå Error sincronizando puntos', 'error');
            }
            
            showLoading(false);
        }

        async function syncFromAirtable(table) {
            if (!airtableConfig.connected) {
                showNotification('‚ùå No est√° conectado a Airtable', 'error');
                return;
            }

            showLoading(true);
            
            try {
                if (table === 'vehicles') {
                    await loadVehiclesFromAirtable();
                    showNotification('‚úÖ Datos de furgones importados desde Airtable', 'success');
                } else if (table === 'points') {
                    await loadPointsFromAirtable();
                    showNotification('‚úÖ Datos de puntos importados desde Airtable', 'success');
                } else if (table === 'assignments') {
                    await loadAssignmentsFromAirtable();
                    showNotification('‚úÖ Datos de asignaciones importados desde Airtable', 'success');
                }
                
            } catch (error) {
                showNotification('‚ùå Error importando desde Airtable: ' + error.message, 'error');
            }
            
            showLoading(false);
        }

        async function syncToAirtable(table) {
            if (!airtableConfig.connected) {
                showNotification('‚ùå No est√° conectado a Airtable', 'error');
                return;
            }

            document.getElementById('syncAlert').classList.remove('hidden');
            
            try {
                if (table === 'assignments') {
                    const pendingAssignments = assignments.filter(a => !a.airtableId);
                    
                    for (const assignment of pendingAssignments) {
                        try {
                            const airtableId = await createAssignmentInAirtable(assignment);
                            if (airtableId) {
                                assignment.airtableId = airtableId;
                                assignment.syncStatus = 'synced';
                            }
                        } catch (error) {
                            console.error('Error sincronizando asignaci√≥n:', assignment.id, error);
                        }
                    }
                    
                    updateAssignmentsTable();
                    showNotification(`‚úÖ ${pendingAssignments.length} asignaciones sincronizadas`, 'success');
                }
                
                document.getElementById('syncAlert').classList.add('hidden');
                
            } catch (error) {
                document.getElementById('syncAlert').classList.add('hidden');
                showNotification('‚ùå Error sincronizando con Airtable: ' + error.message, 'error');
            }
        }

        async function syncSingleAssignment(id) {
            const assignment = assignments.find(a => a.id === id);
            if (assignment && airtableConfig.connected && !assignment.airtableId) {
                try {
                    const airtableId = await createAssignmentInAirtable(assignment);
                    if (airtableId) {
                        assignment.airtableId = airtableId;
                        assignment.syncStatus = 'synced';
                        updateAssignmentsTable();
                        showNotification('‚úÖ Asignaci√≥n sincronizada individualmente', 'success');
                    }
                } catch (error) {
                    showNotification('‚ùå Error sincronizando asignaci√≥n: ' + error.message, 'error');
                }
            }
        }

        async function initializeAirtableData() {
            if (!airtableConfig.connected) {
                showNotification('‚ùå Primero debe conectarse a Airtable', 'error');
                return;
            }
            
            try {
                showNotification('üîÑ Inicializando datos en Airtable...', 'info');
                
                await createInitialVehicles();
                await createInitialPoints();
                await loadInitialData();
                
                showNotification('‚úÖ Datos iniciales creados en Airtable', 'success');
                
            } catch (error) {
                showNotification('‚ùå Error inicializando datos: ' + error.message, 'error');
            }
        }

        async function createInitialVehicles() {
            const defaultVehicles = [
                { Codigo: 'F1', Capacidad_Toneladas: 8, Estado: 'Activo', Conductor: 'Juan P√©rez', Ubicacion_Actual: 'Base Central' },
                { Codigo: 'F2', Capacidad_Toneladas: 10, Estado: 'Activo', Conductor: 'Mar√≠a Garc√≠a', Ubicacion_Actual: 'En ruta' },
                { Codigo: 'F3', Capacidad_Toneladas: 12, Estado: 'Mantenimiento', Conductor: '', Ubicacion_Actual: 'Taller' }
            ];

            const url = `https://api.airtable.com/v0/${airtableConfig.baseId}/${airtableConfig.tables.vehicles}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${airtableConfig.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        records: defaultVehicles.map(vehicle => ({ fields: vehicle }))
                    })
                });

                if (response.ok) {
                    console.log('Veh√≠culos iniciales creados en Airtable');
                }
            } catch (error) {
                console.error('Error creando veh√≠culos iniciales:', error);
            }
        }

        async function createInitialPoints() {
            const defaultPoints = [
                { 
                    Codigo: 'P1', 
                    Direccion: 'Av. Principal 123 - Centro Comercial Plaza', 
                    Tipo_Residuo: 'Mixto', 
                    Volumen_Estimado: 15, 
                    Frecuencia: 'Diaria',
                    Coordenadas_GPS: '-12.0464, -77.0428'
                },
                { 
                    Codigo: 'P2', 
                    Direccion: 'Jr. Comercio 456 - Mercado Central', 
                    Tipo_Residuo: 'Org√°nico', 
                    Volumen_Estimado: 25, 
                    Frecuencia: 'Diaria',
                    Coordenadas_GPS: '-12.0546, -77.0365'
                },
                { 
                    Codigo: 'P3', 
                    Direccion: 'Calle Las Flores 789 - Zona Residencial Norte', 
                    Tipo_Residuo: 'Inorg√°nico', 
                    Volumen_Estimado: 8, 
                    Frecuencia: 'Inter-diaria',
                    Coordenadas_GPS: '-12.0623, -77.0512'
                },
                { 
                    Codigo: 'P4', 
                    Direccion: 'Av. Industrial 321 - Parque Industrial', 
                    Tipo_Residuo: 'Industrial', 
                    Volumen_Estimado: 30, 
                    Frecuencia: 'Diaria',
                    Coordenadas_GPS: '-12.0234, -77.0891'
                }
            ];

            const url = `https://api.airtable.com/v0/${airtableConfig.baseId}/${airtableConfig.tables.points}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${airtableConfig.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        records: defaultPoints.map(point => ({ fields: point }))
                    })
                });

                if (response.ok) {
                    console.log('Puntos iniciales creados en Airtable');
                }
            } catch (error) {
                console.error('Error creando puntos iniciales:', error);
            }
        }

        // Funciones de interfaz
        function updateConnectionStatus(connected) {
            const statusDiv = document.getElementById('connectionStatus');
            const iconSpan = document.getElementById('statusIcon');
            const textSpan = document.getElementById('statusText');
            
            if (connected) {
                statusDiv.className = 'sync-status connected';
                iconSpan.textContent = '‚úÖ';
                textSpan.textContent = 'Conectado a Airtable';
            } else {
                statusDiv.className = 'sync-status disconnected';
                iconSpan.textContent = '‚ùå';
                textSpan.textContent = 'Desconectado de Airtable';
            }
            
            updateLastSyncTime();
        }

        function updateLastSyncTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('es-PE', {hour: '2-digit', minute: '2-digit'});
            document.getElementById('lastSync').textContent = timeStr;
        }

        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (show) {
                spinner.classList.remove('hidden');
            } else {
                spinner.classList.add('hidden');
            }
        }

        function updateSyncStatusTable(table, count) {
            const now = new Date().toLocaleTimeString('es-PE', {hour: '2-digit', minute: '2-digit'});
            
            if (table === 'assignments') {
                document.getElementById('airtableAssignments').textContent = count;
                document.getElementById('assignmentsLastSync').textContent = now;
            } else if (table === 'vehicles') {
                document.getElementById('airtableVehicles').textContent = count;
                document.getElementById('vehiclesLastSync').textContent = now;
            } else if (table === 'points') {
                document.getElementById('airtablePoints').textContent = count;
                document.getElementById('pointsLastSync').textContent = now;
            }
        }

        function updateSyncMetrics() {
            const totalSynced = assignments.length + vehicles.length + points.length;
            document.getElementById('totalSynced').textContent = totalSynced;
            document.getElementById('syncErrors').textContent = '0';
        }

        // Sincronizaci√≥n autom√°tica
        function startAutoSync() {
            const interval = parseInt(document.getElementById('syncInterval').value) * 1000;
            
            syncTimer = setInterval(async () => {
                if (airtableConfig.connected && document.getElementById('autoSync').checked) {
                    console.log('Auto-sync ejecut√°ndose...');
                    await syncAllData();
                }
            }, interval);
            
            showNotification('üîÑ Sincronizaci√≥n autom√°tica iniciada', 'info');
        }

        function stopAutoSync() {
            if (syncTimer) {
                clearInterval(syncTimer);
                syncTimer = null;
                showNotification('‚èπÔ∏è Sincronizaci√≥n autom√°tica detenida', 'warning');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert ${type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'success'}`;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '1000';
            notification.style.minWidth = '300px';
            notification.innerHTML = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // Funci√≥n para validaci√≥n matem√°tica en el simulador
        function validateMathematically() {
            const vehicle = document.getElementById('testVehicle').value;
            const point = document.getElementById('testPoint').value;
            const shift = document.getElementById('testShift').value;

            const testAssignment = {
                vehicle: vehicle,
                point: point,
                shift: shift,
                date: '2025-07-14'
            };

            const hasConflictResult = hasConflict(testAssignment);
            const resultDiv = document.getElementById('mathResult');
            const detailsDiv = document.getElementById('mathDetails');

            let analysis = `
                <strong>An√°lisis de Teor√≠a de Conjuntos:</strong><br>
                ‚Ä¢ Elemento propuesto: (${vehicle}, ${point}, ${shift})<br>
                ‚Ä¢ Verificando intersecciones con asignaciones existentes...<br><br>
                
                <strong>An√°lisis de L√≥gica Proposicional:</strong><br>
                ‚Ä¢ P: "${vehicle} asignado a ${point} en turno ${shift}"<br>
                ‚Ä¢ Q: "No existe conflicto con asignaciones actuales"<br>
                ‚Ä¢ Evaluando: P ‚Üí Q<br><br>
                
                <strong>An√°lisis de √Ålgebra de Boole:</strong><br>
                ‚Ä¢ Variable: A_${vehicle.slice(1)}${point.slice(1)}${shift} = 1<br>
                ‚Ä¢ Restricci√≥n furg√≥n: ‚àë A_${vehicle.slice(1)}j${shift} ‚â§ 1<br>
                ‚Ä¢ Restricci√≥n punto: ‚àë A_i${point.slice(1)}${shift} ‚â§ 1<br><br>
                
                <strong>Resultado:</strong><br>
            `;

            if (hasConflictResult) {
                analysis += `<span style="color: #721c24; font-weight: bold;">‚ùå CONFLICTO DETECTADO</span><br>
                            La asignaci√≥n viola las restricciones matem√°ticas del sistema.`;
                resultDiv.style.background = '#f8d7da';
                resultDiv.style.border = '1px solid #f5c6cb';
            } else {
                analysis += `<span style="color: #155724; font-weight: bold;">‚úÖ ASIGNACI√ìN V√ÅLIDA</span><br>
                            La asignaci√≥n cumple con todas las restricciones matem√°ticas.`;
                resultDiv.style.background = '#d4edda';
                resultDiv.style.border = '1px solid #c3e6cb';
            }

            detailsDiv.innerHTML = analysis;
            resultDiv.style.display = 'block';
        }

        // Funciones del sistema original
        function generateReport() {
            const reportData = {
                totalAssignments: assignments.length,
                conflicts: 0,
                efficiency: 87,
                vehicleUtilization: {
                    F1: 92,
                    F2: 88,
                    F3: 0
                },
                costSavings: {
                    fuel: 127,
                    time: 8.5,
                    avoided: 2400
                }
            };

            console.log('Reporte generado:', reportData);
            showNotification('üìä Reporte generado exitosamente. Datos disponibles en la consola del navegador.', 'success');
        }

        function exportData() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "ID,Fecha,Turno,Furgon,Punto,Estado,AirtableID\n" +
                assignments.map(a => `${a.id},${a.date},${a.shift},${a.vehicle},${a.point},${a.status},${a.airtableId || ''}`).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "asignaciones_petramas.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('üì§ Datos exportados exitosamente', 'success');
        }

        function backupData() {
            const backup = {
                assignments: assignments,
                vehicles: vehicles,
                points: points,
                airtableConfig: {
                    baseId: airtableConfig.baseId,
                    tables: airtableConfig.tables
                },
                timestamp: new Date().toISOString(),
                version: "2.0"
            };
            
            localStorage.setItem('petramas_backup', JSON.stringify(backup));
            showNotification('üíæ Backup guardado localmente con √©xito.', 'success');
        }

        function restoreData() {
            const backup = localStorage.getItem('petramas_backup');
            if (backup) {
                const data = JSON.parse(backup);
                assignments = data.assignments || assignments;
                vehicles = data.vehicles || vehicles;
                points = data.points || points;
                
                updateAssignmentsTable();
                updateVehiclesTable();
                updatePointsTable();
                updateMetrics();
                showNotification('üì• Datos restaurados exitosamente.', 'success');
            } else {
                showNotification('‚ùå No se encontr√≥ backup previo.', 'error');
            }
        }

        function optimizeRoutes() {
            showNotification('üîÑ Iniciando optimizaci√≥n autom√°tica de rutas...', 'info');
            
            setTimeout(() => {
                showNotification('‚úÖ Optimizaci√≥n completada. Rutas actualizadas usando algoritmos de matem√°ticas discretas.', 'success');
            }, 2000);
        }

        // Event listeners para configuraci√≥n autom√°tica
        document.addEventListener('DOMContentLoaded', function() {
            updateAssignmentsTable();
            updateVehiclesTable();
            updatePointsTable();
            updateMetrics();
            
            // Establecer fecha actual
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('assignDate').value = today;
            
            // Event listener para auto-sync
            document.getElementById('autoSync').addEventListener('change', function() {
                if (this.checked && airtableConfig.connected) {
                    startAutoSync();
                } else {
                    stopAutoSync();
                }
            });
            
            // Event listener para intervalo de sincronizaci√≥n
            document.getElementById('syncInterval').addEventListener('change', function() {
                if (airtableConfig.connected && document.getElementById('autoSync').checked) {
                    stopAutoSync();
                    startAutoSync();
                }
            });
            
            // Validaci√≥n en tiempo real de campos
            const vehicleSelect = document.getElementById('assignVehicle');
            const pointSelect = document.getElementById('assignPoint');
            const shiftSelect = document.getElementById('assignShift');
            const dateInput = document.getElementById('assignDate');

            function validateInRealTime() {
                const vehicle = vehicleSelect.value;
                const point = pointSelect.value;
                const shift = shiftSelect.value;
                const date = dateInput.value;

                if (vehicle && point && shift && date) {
                    const testAssignment = { vehicle, point, shift, date };
                    const conflict = hasConflict(testAssignment);
                    
                    if (conflict) {
                        showNotification('‚ö†Ô∏è Advertencia: Esta combinaci√≥n generar√° un conflicto', 'error');
                    }
                }
            }

            [vehicleSelect, pointSelect, shiftSelect, dateInput].forEach(element => {
                element.addEventListener('change', validateInRealTime);
            });
            
            // Mensaje de bienvenida
            setTimeout(() => {
                showNotification('üéâ Sistema Petram√°s con integraci√≥n Airtable iniciado correctamente', 'success');
            }, 1000);
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petram√°s S.A.C. - Sistema de Asignaci√≥n de Rutas con Airtable</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(90deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-card h3 {
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .metric-card .value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid #3498db;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .form-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group select, .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus, .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }

        .btn-airtable {
            background: linear-gradient(135deg, #f9b334 0%, #f39c12 100%);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9em;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status.valid {
            background: #d4edda;
            color: #155724;
        }

        .status.conflict {
            background: #f8d7da;
            color: #721c24;
        }

        .status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status.synced {
            background: #cce5ff;
            color: #004085;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px 10px 0 0;
            margin-bottom: 0;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: white;
            color: #3498db;
        }

        .tab-content {
            background: white;
            padding: 25px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .hidden {
            display: none;
        }

        .chart-container {
            height: 300px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .math-formula {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
        }

        .airtable-config {
            background: #fff9e6;
            border: 2px solid #f39c12;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .sync-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .sync-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöõ Petram√°s S.A.C.</h1>
            <p>Sistema Inteligente de Asignaci√≥n de Rutas - Integrado con Airtable</p>
        </div>

        <div class="main-content">
            <!-- Estado de Conexi√≥n Airtable -->
            <div id="connectionStatus" class="sync-status disconnected">
                <span id="statusIcon">‚ùå</span>
                <span id="statusText">Desconectado de Airtable</span>
                <div id="loadingSpinner" class="loading hidden"></div>
            </div>

            <!-- Dashboard de M√©tricas -->
            <div class="dashboard">
                <div class="metric-card">
                    <h3>Asignaciones Hoy</h3>
                    <div class="value" id="totalAssignments">3</div>
                    <small id="syncedCount">0 sincronizadas</small>
                </div>
                <div class="metric-card">
                    <h3>Conflictos Detectados</h3>
                    <div class="value" id="conflictsDetected">0</div>
                    <small>Resueltos autom√°ticamente</small>
                </div>
                <div class="metric-card">
                    <h3>Eficiencia de Flota</h3>
                    <div class="value" id="fleetEfficiency">87%</div>
                    <small>Optimizado con IA</small>
                </div>
                <div class="metric-card">
                    <h3>√öltima Sincronizaci√≥n</h3>
                    <div class="value" id="lastSync">--:--</div>
                    <small>Airtable sync</small>
                </div>
            </div>

            <!-- Navegaci√≥n por Pesta√±as -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('airtable')">üîó Configuraci√≥n Airtable</button>
                <button class="tab" onclick="showTab('assignments')">üìã Asignaciones</button>
                <button class="tab" onclick="showTab('vehicles')">üöõ Furgones</button>
                <button class="tab" onclick="showTab('points')">üìç Puntos de Recolecci√≥n</button>
                <button class="tab" onclick="showTab('analytics')">üìä An√°lisis</button>
                <button class="tab" onclick="showTab('math')">üßÆ Fundamentos Matem√°ticos</button>
            </div>

            <!-- Configuraci√≥n de Airtable -->
            <div id="airtable" class="tab-content">
                <div class="section">
                    <h2>Configuraci√≥n de Airtable</h2>
                    <div class="airtable-config">
                        <h3>üîë Credenciales de Conexi√≥n</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="airtableToken">Personal Access Token:</label>
                                <input type="password" id="airtableToken" placeholder="patXXXXXXXXXXXXXX.xxxxxxxxxxxxxxx">
                            </div>
                            <div class="form-group">
                                <label for="airtableBaseId">Base ID:</label>
                                <input type="text" id="airtableBaseId" placeholder="appXXXXXXXXXXXXXX">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="assignmentsTableId">Tabla Asignaciones:</label>
                                <input type="text" id="assignmentsTableId" placeholder="tblXXXXXXXXXXXXXX" value="Asignaciones">
                            </div>
                            <div class="form-group">
                                <label for="vehiclesTableId">Tabla Furgones:</label>
                                <input type="text" id="vehiclesTableId" placeholder="tblXXXXXXXXXXXXXX" value="Furgones">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="pointsTableId">Tabla Puntos:</label>
                                <input type="text" id="pointsTableId" placeholder="tblXXXXXXXXXXXXXX" value="Puntos_Recoleccion">
                            </div>
                            <div class="form-group">
                                <label for="syncInterval">Intervalo de Sincronizaci√≥n (seg):</label>
                                <input type="number" id="syncInterval" value="30" min="10" max="300">
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-airtable" onclick="connectToAirtable()">üîó Conectar a Airtable</button>
                            <button class="btn btn-success" onclick="testConnection()">üß™ Probar Conexi√≥n</button>
                            <button class="btn" onclick="syncAllData()">‚ö° Sincronizar Todo</button>
                            <button class="btn" onclick="initializeAirtableData()">üöÄ Inicializar Datos</button>
                            <button class="btn btn-danger" onclick="disconnectAirtable()">‚ùå Desconectar</button>
                        </div>
                    </div>

                    <div class="section">
                        <h3>üìä Estado de Sincronizaci√≥n</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Tabla</th>
                                        <th>Registros Locales</th>
                                        <th>Registros Airtable</th>
                                        <th>√öltima Sync</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="syncStatusTable">
                                    <tr>
                                        <td>Asignaciones</td>
                                        <td id="localAssignments">3</td>
                                        <td id="airtableAssignments">-</td>
                                        <td id="assignmentsLastSync">Nunca</td>
                                        <td><span class="status pending">Pendiente</span></td>
                                        <td><button class="btn" onclick="syncAssignments()">‚ö° Sync</button></td>
                                    </tr>
                                    <tr>
                                        <td>Furgones</td>
                                        <td id="localVehicles">3</td>
                                        <td id="airtableVehicles">-</td>
                                        <td id="vehiclesLastSync">Nunca</td>
                                        <td><span class="status pending">Pendiente</span></td>
                                        <td><button class="btn" onclick="syncVehicles()">‚ö° Sync</button></td>
                                    </tr>
                                    <tr>
                                        <td>Puntos</td>
                                        <td id="localPoints">4</td>
                                        <td id="airtablePoints">-</td>
                                        <td id="pointsLastSync">Nunca</td>
                                        <td><span class="status pending">Pendiente</span></td>
                                        <td><button class="btn" onclick="syncPoints()">‚ö° Sync</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="section">
                        <h3>üîß Configuraci√≥n Avanzada</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="autoSync"> Sincronizaci√≥n Autom√°tica
                                </label>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="bidirectionalSync"> Sincronizaci√≥n Bidireccional
                                </label>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="conflictResolution"> Resoluci√≥n Autom√°tica de Conflictos
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido de Asignaciones -->
            <div id="assignments" class="tab-content hidden">
                <div class="section">
                    <h2>Nueva Asignaci√≥n de Ruta</h2>
                    <div class="form-section">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="assignDate">Fecha de Asignaci√≥n:</label>
                                <input type="date" id="assignDate" value="2025-07-14">
                            </div>
                            <div class="form-group">
                                <label for="assignShift">Turno:</label>
                                <select id="assignShift">
                                    <option value="">Seleccionar turno...</option>
                                    <option value="M">Ma√±ana (06:00 - 14:00)</option>
                                    <option value="T">Tarde (14:00 - 22:00)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="assignVehicle">Furg√≥n:</label>
                                <select id="assignVehicle">
                                    <option value="">Seleccionar furg√≥n...</option>
                                    <option value="F1">F1 - Capacidad 8 ton</option>
                                    <option value="F2">F2 - Capacidad 10 ton</option>
                                    <option value="F3">F3 - Capacidad 12 ton</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="assignPoint">Punto de Recolecci√≥n:</label>
                                <select id="assignPoint">
                                    <option value="">Seleccionar punto...</option>
                                    <option value="P1">P1 - Centro Comercial Plaza</option>
                                    <option value="P2">P2 - Mercado Central</option>
                                    <option value="P3">P3 - Zona Residencial Norte</option>
                                    <option value="P4">P4 - Parque Industrial</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn" onclick="addAssignment()">‚ûï Crear Asignaci√≥n</button>
                            <button class="btn btn-airtable" onclick="syncToAirtable('assignments')">‚òÅÔ∏è Sincronizar con Airtable</button>
                            <button class="btn" onclick="validateAllAssignments()">üîç Validar Todas</button>
                            <button class="btn btn-danger" onclick="clearAssignments()">üóëÔ∏è Limpiar Todo</button>
                        </div>
                    </div>

                    <div id="validationAlert" class="alert success hidden">
                        ‚úÖ Asignaci√≥n creada y sincronizada exitosamente
                    </div>
                    <div id="conflictAlert" class="alert error hidden">
                        ‚ö†Ô∏è Conflicto detectado: Esta asignaci√≥n viola las reglas matem√°ticas
                    </div>
                    <div id="syncAlert" class="alert warning hidden">
                        ‚òÅÔ∏è Sincronizando con Airtable...
                    </div>
                </div>

                <div class="section">
                    <h2>Asignaciones Actuales</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Fecha</th>
                                    <th>Turno</th>
                                    <th>Furg√≥n</th>
                                    <th>Punto</th>
                                    <th>Estado</th>
                                    <th>Airtable ID</th>
                                    <th>Sync Status</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="assignmentsTable">
                                <!-- Datos se cargar√°n din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Controles del Sistema -->
                <div class="section" style="text-align: center; margin-top: 20px;">
                    <h3>Controles del Sistema</h3>
                    <button class="btn" onclick="generateReport()">üìä Generar Reporte</button>
                    <button class="btn" onclick="exportData()">üì§ Exportar CSV</button>
                    <button class="btn" onclick="backupData()">üíæ Crear Backup</button>
                    <button class="btn" onclick="restoreData()">üì• Restaurar Backup</button>
                    <button class="btn" onclick="optimizeRoutes()">üöÄ Optimizar Rutas</button>
                </div>
            </div>

            <!-- Contenido de Furgones -->
            <div id="vehicles" class="tab-content hidden">
                <div class="section">
                    <h2>Gesti√≥n de Furgones</h2>
                    <button class="btn btn-airtable" onclick="syncFromAirtable('vehicles')" style="margin-bottom: 20px;">
                        ‚¨áÔ∏è Importar desde Airtable
                    </button>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>C√≥digo</th>
                                    <th>Capacidad (ton)</th>
                                    <th>Estado</th>
                                    <th>Conductor</th>
                                    <th>Ubicaci√≥n Actual</th>
                                    <th>Asignaciones Hoy</th>
                                    <th>Airtable ID</th>
                                    <th>Sync Status</th>
                                </tr>
                            </thead>
                            <tbody id="vehiclesTable">
                                <!-- Datos se cargar√°n din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Contenido de Puntos -->
            <div id="points" class="tab-content hidden">
                <div class="section">
                    <h2>Puntos de Recolecci√≥n</h2>
                    <button class="btn btn-airtable" onclick="syncFromAirtable('points')" style="margin-bottom: 20px;">
                        ‚¨áÔ∏è Importar desde Airtable
                    </button>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>C√≥digo</th>
                                    <th>Direcci√≥n</th>
                                    <th>Tipo Residuo</th>
                                    <th>Volumen (m¬≥)</th>
                                    <th>Frecuencia</th>
                                    <th>Coordenadas GPS</th>
                                    <th>Airtable ID</th>
                                    <th>Sync Status</th>
                                </tr>
                            </thead>
                            <tbody id="pointsTable">
                                <!-- Datos se cargar√°n din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Contenido de An√°lisis -->
            <div id="analytics" class="tab-content hidden">
                <div class="section">
                    <h2>Dashboard de An√°lisis y Reportes</h2>
                    
                    <div class="chart-container">
                        <h3>Sincronizaci√≥n con Airtable - √öltimos 7 d√≠as</h3>
                        <div style="display: flex; justify-content: space-around; align-items: end; height: 200px; padding: 20px;">
                            <div style="text-align: center;">
                                <div style="height: 100px; width: 30px; background: #27ae60; margin: 0 auto 10px;"></div>
                                <small>Lun</small><br><strong>24</strong>
                            </div>
                            <div style="text-align: center;">
                                <div style="height: 80px; width: 30px; background: #3498db; margin: 0 auto 10px;"></div>
                                <small>Mar</small><br><strong>18</strong>
                            </div>
                            <div style="text-align: center;">
                                <div style="height: 120px; width: 30px; background: #27ae60; margin: 0 auto 10px;"></div>
                                <small>Mi√©</small><br><strong>32</strong>
                            </div>
                            <div style="text-align: center;">
                                <div style="height: 90px; width: 30px; background: #f39c12; margin: 0 auto 10px;"></div>
                                <small>Jue</small><br><strong>21</strong>
                            </div>
                            <div style="text-align: center;">
                                <div style="height: 110px; width: 30px; background: #27ae60; margin: 0 auto 10px;"></div>
                                <small>Vie</small><br><strong>28</strong>
                            </div>
                            <div style="text-align: center;">
                                <div style="height: 75px; width: 30px; background: #9b59b6; margin: 0 auto 10px;"></div>
                                <small>S√°b</small><br><strong>15</strong>
                            </div>
                            <div style="text-align: center;">
                                <div style="height: 95px; width: 30px; background: #e74c3c; margin: 0 auto 10px;"></div>
                                <small>Dom</small><br><strong>22</strong>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div style="background: #d4edda; padding: 20px; border-radius: 10px; text-align: center;">
                            <h4 style="color: #155724;">Datos Sincronizados</h4>
                            <div style="font-size: 2em; color: #155724; font-weight: bold;" id="totalSynced">0</div>
                            <small>Registros esta semana</small>
                        </div>
                        <div style="background: #cce5ff; padding: 20px; border-radius: 10px; text-align: center;">
                            <h4 style="color: #004085;">Tiempo de Respuesta</h4>
                            <div style="font-size: 2em; color: #004085; font-weight: bold;" id="avgResponseTime">--</div>
                            <small>Promedio API Airtable</small>
                        </div>
                        <div style="background: #fff3cd; padding: 20px; border-radius: 10px; text-align: center;">
                            <h4 style="color: #856404;">Errores Sync</h4>
                            <div style="font-size: 2em; color: #856404; font-weight: bold;" id="syncErrors">0</div>
                            <small>En las √∫ltimas 24h</small>
                        </div>
                    </div>

                    <div class="section">
                        <h3>Reporte de Ahorro de Costos</h3>
                        <div class="form-row">
                            <div style="background: #d4edda; padding: 20px; border-radius: 10px; text-align: center;">
